function vaultSPA(c,a,f){function d(){var y=new AjaxGetUser(c),b=new AjaxGetUserChildren(c),d=new getVaultBrands,q=new getVaultInterests,e=new AjaxGetAllEvents;g=new progressBar(a,5,f);g.setTitle("Looking at your interests");$.when(y.fetch()).then(function(a){sessionStorage.setItem("currentUser",JSON.stringify(a));v=a;g.completeStep();g.setTitle("Learning about your People...");$.when(b.fetch()).then(function(a){sessionStorage.setItem("currentUserChildren",JSON.stringify(a));t=a;g.completeStep();
g.setTitle("Filtering event brands...");$.when(d.fetch()).then(function(a){sessionStorage.setItem("vaultBrands",JSON.stringify(a));w=a;g.completeStep();g.setTitle("Filtering event interests...");$.when(q.fetch()).then(function(a){sessionStorage.setItem("vaultInterests",JSON.stringify(a));r=a;g.completeStep();g.setTitle("Preparing your events...");$.when(e.fetch()).then(function(a){sessionStorage.setItem("vaultItems",JSON.stringify(a));h=a;k();g.completeStep()})})})})})}function k(){var a=[];$.each(r,
function(){var b=this.interestId;$.each(this.items,function(){null==a[this]&&(a[this]=[]);a[this].push(b)})});var b=(new Date).getTime()/1E3;h.items=h.items.filter(function(a){return b<=a.startDateTimeEpoc});h.totalItems=h.items.length;$.each(h.items,function(){var b=this.itemId,q=findWithAttr(h.items,"itemId",b);h.items[q].interests=a[b];h.items[q].suggestions=l(b)});sessionStorage.setItem("vaultItems",JSON.stringify(h))}function l(a){var b=0;a=findWithAttr(h.items,"itemId",a);var c=h.items[a].interests;
null!=c&&$.each(t,function(){var a=this.interests;null!=a&&anyMatchInArray(c,a)&&b++});return b}var g=null,v=$.parseJSON(sessionStorage.getItem("currentUser")),t=$.parseJSON(sessionStorage.getItem("currentUserChildren")),w=$.parseJSON(sessionStorage.getItem("vaultBrands")),r=$.parseJSON(sessionStorage.getItem("vaultInterests")),h=$.parseJSON(sessionStorage.getItem("vaultItems")),m=null,n=null,p=null,x=!1,u=null,e=[],b={};d();this.reset=function(){for(var a=sessionStorage.length;a--;){var b=sessionStorage.key(a);
sessionStorage.removeItem(b)}d()};this.setSort=function(a,b){x=b;u=a;this.refineSearch()};this.getFilteredResults=function(){return e};this.getUser=function(){return v};this.getChildren=function(){return t};this.getItems=function(){return h};this.addFilter=function(a,c){b[a]=c;this.refineSearch()};this.getBrands=function(){return w};this.getInterests=function(){return r};this.getFilters=function(){return b};this.setDistance=function(a){p=a;this.refineSearch()};this.setSearchLatLng=function(a,b){m=
a;n=b;this.refineSearch()};this.resetFilters=function(){b=[]};this.refineSearch=function(){e=this.getItems().items;null!=b.isByArrangement&&(e=e.filter(function(a){return a.isByArrangement==b.isByArrangement}));null!=b.pricePerAttendee&&(e=e.filter(function(a){return"fixed"==b.pricePerAttendee?1<=a.unitPrice:0==a.unitPrice}));null!=b.brand&&0!=b.brand.length&&(e=e.filter(function(a){return-1!=$.inArray(a.creatorOrganisationId,b.brand)}));if(null!=b.interest&&0!=b.interest.length){var a=[];$.each(b.interest,
function(){a=$.merge(a,r[this].items)});a=unique(a);e=e.filter(function(b){return-1!=$.inArray(b.itemId,a)})}null!=b.age&&0!=b.age.length&&(e=e.filter(function(a){if(-1!=$.inArray("targetAge18to34",b.age)&&"1"==a.targetAge18to34||-1!=$.inArray("targetAge34to65",b.age)&&"1"==a.targetAge34to65||-1!=$.inArray("targetAge65Plus",b.age)&&"1"==a.targetAge65Plus)return!0}));null!=b.gender&&0!=b.gender.length&&(e=e.filter(function(a){if(-1!=$.inArray("male",b.gender)&&"male"==a.gender||-1!=$.inArray("female",
b.gender)&&"female"==a.gender||-1!=$.inArray("mixed",b.gender)&&"mixed"==a.gender)return!0}));if(null!=p&&null!=m&&null!=n){var c=parseFloat(.012*p),d=parseFloat(.02*p);$.each(e,function(){var a=parseFloat(this.latitude),b=parseFloat(this.longitude);null!=this.latitude&&null!=this.longitude&&(this.distance=Math.ceil(calculateDistance(m,n,a,b,"N")))});e=e.filter(function(a){var b=parseFloat(a.latitude),e=parseFloat(a.longitude);if(b>m-c&&b<m+c&&e<n+d&&e>n-d||"any"==p&&null!=a.distance)return!0})}else $.each(e,
function(){this.distance=null});null!=u&&e.sort(dynamicSort(u));0!=x&&e.reverse()}}function AjaxGetAllEvents(){this.ajax=function(){return $.ajax({url:"/vault/AjaxGetAllEvents/",type:"get",dataType:"json"})};this.fetch=function(){return this.ajax()}}var anyMatchInArray=function(c,a){var f,d,k,l,g;f=!1;d={};k=0;for(l=c.length;k<l;k++)g=c[k],d[g]=!0;k=0;for(l=a.length;!f&&k<l;k++)g=a[k],f=!!d[g];return f};function unique(c){var a=[];$.each(c,function(c,d){-1==$.inArray(d,a)&&a.push(d)});return a}
function calculateDistance(c,a,f,d,k){c=Math.PI*c/180;f=Math.PI*f/180;a=Math.sin(c)*Math.sin(f)+Math.cos(c)*Math.cos(f)*Math.cos(Math.PI*(a-d)/180);a=Math.acos(a);a=180*a/Math.PI;a*=69.09;"K"==k&&(a*=1.609344);"N"==k&&(a*=.8684);return a}function findWithAttr(c,a,f){for(var d=0;d<c.length;d+=1)if(c[d][a]===f)return d}function dynamicSort(c){var a=1;"-"===c[0]&&(a=-1,c=c.substr(1));return function(f,d){return(f[c]<d[c]?-1:f[c]>d[c]?1:0)*a}};
